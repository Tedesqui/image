<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Pet Virtual em RA (Sem Marcador)</title>
    
    <!-- A-Frame é a única biblioteca necessária para WebXR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Estilo para a sobreposição de instruções e o botão de início */
        .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
        }

        #instructions {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            max-width: 400px;
        }

        #enter-ar-btn {
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: #007AFF;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #enter-ar-btn:hover {
            background-color: #0056b3;
        }

        /* Oculta o botão padrão do A-Frame para evitar confusão */
        .a-enter-ar-button {
            display: none !important;
        }
    </style>
</head>
<body style="margin : 0px; overflow: hidden;">
    
    <!-- Sobreposição com instruções e botão de início -->
    <div id="overlay-ui" class="overlay">
        <div id="instructions">
            Clique em 'Iniciar RA' para começar.
        </div>
        <button id="enter-ar-btn">Iniciar RA</button>
    </div>

    <!-- A cena de Realidade Aumentada -->
    <a-scene
        webxr="requiredFeatures: hit-test,local-floor; optionalFeatures: dom-overlay; overlayElement: #overlay-ui"
        ar-hit-test="enabled: false" <!-- Desativado inicialmente -->
        renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;">

        <!-- Recursos a serem pré-carregados -->
        <a-assets>
            <img id="shadow-texture" src="https://raw.githubusercontent.com/aframevr/aframe/v1.0.4/examples/boilerplate/vr-logo/assets/radial-shadow-2.png">
        </a-assets>

        <!-- Câmera da cena -->
        <a-camera position="0 1.6 0"></a-camera>

        <!-- O nosso pet virtual. Inicialmente invisível. -->
        <a-entity id="pet-container" position="0 -10 0" visible="false">
            <!-- O corpo do nosso pet virtual -->
            <a-entity id="pet-body" position="0 0.75 0" geometry="primitive: sphere; radius: 0.4;" material="color: #FFD700; metalness: 0.3; roughness: 0.4;">
                
                <a-sphere position="-0.15 0.15 0.3" radius="0.08" color="#222222"></a-sphere>
                <a-sphere position="0.15 0.15 0.3" radius="0.08" color="#222222"></a-sphere>
                <a-sphere position="-0.12 0.18 0.35" radius="0.03" color="white"></a-sphere>
                <a-sphere position="0.18 0.18 0.35" radius="0.03" color="white"></a-sphere>

                <a-animation attribute="position" to="0 0.85 0" dur="1500" direction="alternate" repeat="indefinite" easing="ease-in-out-sine"></a-animation>
                <a-animation begin="click" attribute="position" from="0 0.75 0" to="0 1.5 0" dur="200" direction="alternate" repeat="1" easing="ease-out-quad"></a-animation>
            </a-entity>

            <!-- Sombra -->
            <a-plane position="0 0.01 0" rotation="-90 0 0" width="1.5" height="1.5" material="src: #shadow-texture; transparent: true; opacity: 0.6;"></a-plane>
        </a-entity>

    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');
            const enterArBtn = document.getElementById('enter-ar-btn');
            const instructions = document.getElementById('instructions');
            const petContainer = document.getElementById('pet-container');
            let petPlaced = false;

            // Quando o utilizador clica no botão para iniciar a RA
            enterArBtn.addEventListener('click', () => {
                // Tenta entrar no modo de RA
                sceneEl.enterVR(true);
            });

            // Quando a sessão de RA começa com sucesso
            sceneEl.addEventListener('enter-vr', () => {
                // Esconde o botão e atualiza as instruções
                enterArBtn.style.display = 'none';
                instructions.textContent = 'Mova o telemóvel para encontrar uma superfície.';
                // Ativa o hit-test apenas depois de entrar em RA
                sceneEl.setAttribute('ar-hit-test', 'enabled', true);
            });

            // Quando a sessão de RA termina
             sceneEl.addEventListener('exit-vr', () => {
                // Mostra o botão e as instruções iniciais novamente
                enterArBtn.style.display = 'block';
                instructions.textContent = "Clique em 'Iniciar RA' para começar.";
                petContainer.setAttribute('visible', 'false');
                petContainer.setAttribute('position', '0 -10 0');
                petPlaced = false;
                sceneEl.setAttribute('ar-hit-test', 'enabled', false);
            });

            // Quando o utilizador toca no ecrã para colocar o pet
            sceneEl.addEventListener('ar-hit-test-select-start', (event) => {
                if (petPlaced) return;

                const hitPoint = event.detail.intersection.point;
                petContainer.setAttribute('position', hitPoint);
                petContainer.setAttribute('visible', 'true');
                
                petPlaced = true;
                instructions.textContent = 'Toque no seu pet para o fazer pular!';
            });

            // Adiciona um evento de clique ao corpo do pet
            document.getElementById('pet-body').addEventListener('click', function (evt) {
                console.log('Pet clicado! A iniciar animação de pulo.');
                evt.stopPropagation();
            });
        });
    </script>
</body>
</html>
